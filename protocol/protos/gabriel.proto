syntax = "proto3";

package gabriel;

import "google/protobuf/any.proto";

option java_package = "edu.cmu.cs.gabriel.protocol";
option java_outer_classname = "Protos";
option go_package = "github.com/cmusatyalab/gabriel-protocol";

enum PayloadType {
    PAYLOAD_TYPE_UNSPECIFIED = 0;
    TEXT = 1;
    IMAGE = 2;
    AUDIO = 3;
    VIDEO = 4;
    CONTROL = 5;
    OTHER = 100;
}

message InputFrame {
    // The payload type of this input.
    PayloadType payload_type = 1;
    // The payload.
    oneof payload {
        string string_payload = 2;
        bytes byte_payload = 3;
        google.protobuf.Any any_payload = 4;
    }
}

message FromClient {
    // A monotonically increasing frame identifier.
    int64 frame_id = 1;
    // The identifier of the producer generating input.
    string producer_id = 2;
    // The targeted engines for this input.
    repeated string target_engine_ids = 3;
    // The data to be sent to the server.
    InputFrame input_frame = 4;
    // Arbitrary information about the client.
    google.protobuf.Any client_info = 5;
}

enum StatusCode {
    // Success.
    SUCCESS = 0;
    // Errors whose cause is not known.
    UNSPECIFIED_ERROR = 1;
    // Errors that are not related to Gabriel but rather to the engine
    // itself.
    ENGINE_ERROR = 2;
    // Cognitive engine expected different PayloadType from this producer.
    WRONG_INPUT_FORMAT = 3;
    // No cognitive engines found that match the targeted engines.
    NO_ENGINE_FOR_INPUT = 4;
    // This client has no tokens to send frames from this producer.
    NO_TOKENS = 5;
    // The server dropped the frame because it was backed up.
    SERVER_DROPPED_FRAME = 6;

}

message Status {
    // Status code.
    StatusCode code = 1;
    // Status message.
    string message = 2;
}

message Result {
    Status status = 1;
    // Optional returned payload from the engine.
    oneof payload {
        string string_result = 2;
        bytes bytes_result = 3;
        google.protobuf.Any any_result = 4;
    }
    // The engine that produced this response.
    string target_engine_id = 5;
    // The frame id that this result corresponds to.
    int64 frame_id = 6;
}

message ToClient {
    message Welcome {
        // Number of tokens each producer should get.
        int32 num_tokens_per_producer = 1;
        // The engine ids that are connected to the server.
        repeated string engine_ids = 2;
    }

    message Control {
        // The new set of engine ids connected to the server.
        repeated string engine_ids = 1;
    }

    message ResultWrapper {
        // The producer of the original frame; allows the client to return the
        // token correctly.
        string producer_id = 1;
        // Whether to replenish a client token.
        bool return_token = 2;
        // The result sent from the engine.
        Result result = 3;
    }

    oneof message_type {
        Welcome welcome = 1;
        ResultWrapper result_wrapper = 2;
        Control control = 3;
    }
}

message FromStandaloneEngine {
    message Welcome {
        // The engine id.
        string engine_id = 1;
        // Whether all responses from this engine should be sent to the client,
        // even if they do not correspond to the latest input. This flag
        // determines whether stale results are sent to the client.
        bool all_responses_required = 2;
    }

    oneof welcome_or_result {
        Welcome welcome = 1;
        Result result = 2;
    }
}
